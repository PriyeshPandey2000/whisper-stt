<script lang="ts">
	import { Button } from '$lib/ui/button';
	import { onMount } from 'svelte';
	import { rpc } from '$lib/query';
	import CheckIcon from '@lucide/svelte/icons/check';
	import MicIcon from '@lucide/svelte/icons/mic';
	import ShieldIcon from '@lucide/svelte/icons/shield';
	import LoaderIcon from '@lucide/svelte/icons/loader';

	type Props = {
		onNext: () => void;
		onSkip: () => void;
		onComplete: (complete: boolean) => void;
	};

	let { onNext, onSkip, onComplete }: Props = $props();

	type PermissionStatus = 'unknown' | 'granted' | 'denied' | 'requesting';

	let microphoneStatus = $state<PermissionStatus>('unknown');
	let accessibilityStatus = $state<PermissionStatus>('unknown');
	let isCheckingPermissions = $state(false);
	let reinitializeInProgress = $state(false);

	const isDesktop = typeof window !== 'undefined' && !!window.__TAURI_INTERNALS__;
	const totalSteps = isDesktop ? 2 : 1;

	const completedSteps = $derived(
		(microphoneStatus === 'granted' ? 1 : 0) +
			(isDesktop && accessibilityStatus === 'granted' ? 1 : 0)
	);

	const allRequiredGranted = $derived(
		microphoneStatus === 'granted' &&
			(!isDesktop || accessibilityStatus === 'granted')
	);

	async function checkPermissions() {
		console.log('[Onboarding] checkPermissions() called');
		isCheckingPermissions = true;

		const hasMic = await checkMicrophonePermission();
		const previousMicStatus = microphoneStatus;
		microphoneStatus = hasMic ? 'granted' : 'denied';
		console.log('[Onboarding] Microphone status:', microphoneStatus);

		if (isDesktop) {
			const hasAccessibility = await checkAccessibilityPermission();
			const previousAccessibilityStatus = accessibilityStatus;
			const newAccessibilityStatus = hasAccessibility ? 'granted' : 'denied';

			// If accessibility permission just changed from granted to denied (REVOKED!)
			if (previousAccessibilityStatus === 'granted' && newAccessibilityStatus === 'denied') {
				console.warn('[Onboarding] ‚ö†Ô∏è Accessibility permission was REVOKED! Fn keys will not work until permission is re-granted and app is restarted or Fn manager is reinitialized.');
				// CRITICAL: Reset the reinitialize flag so a subsequent re-grant can trigger a new attempt
				reinitializeInProgress = false;
				rpc.notify.warning.execute({
					title: 'Accessibility permission removed',
					description: 'Fn key shortcuts will not work. Please re-grant accessibility permission and restart NoteFlux.',
				});
			}

			// If accessibility permission just changed from denied/unknown to granted
			if (previousAccessibilityStatus !== 'granted' && newAccessibilityStatus === 'granted') {
				console.log('[Onboarding] üéâ Accessibility permission just granted! Reinitializing Fn manager...');
				// Runs in background, doesn't block checkPermissions
				attemptReinitialize();
			}

			accessibilityStatus = newAccessibilityStatus;
			console.log('[Onboarding] Accessibility status:', accessibilityStatus);
		}

		isCheckingPermissions = false;
		console.log('[Onboarding] All required granted:', allRequiredGranted);
		onComplete(allRequiredGranted);
	}

	async function checkMicrophonePermission(): Promise<boolean> {
		try {
			if ('permissions' in navigator) {
				const permissionStatus = await navigator.permissions.query({
					name: 'microphone' as PermissionName,
				});
				return permissionStatus.state === 'granted';
			}
			return false;
		} catch {
			return false;
		}
	}

	async function checkAccessibilityPermission(): Promise<boolean> {
		if (!isDesktop) return true;

		try {
			const { invoke } = await import('@tauri-apps/api/core');
			return await invoke<boolean>('is_macos_accessibility_enabled', {
				askIfNotAllowed: false,
			});
		} catch {
			return false;
		}
	}

	async function attemptReinitialize() {
		if (reinitializeInProgress) {
			console.log('[Onboarding] ‚è≠Ô∏è Reinitialize already in progress, skipping duplicate attempt');
			return;
		}

		reinitializeInProgress = true;

		try {
			console.log('[Onboarding] ‚è≥ Waiting 8s for macOS to fully apply accessibility permission...');
			// Increased from 5s to 8s based on observed timing
			await new Promise((resolve) => setTimeout(resolve, 8000));

			// Check if permission is STILL granted before proceeding
			const stillGranted = await checkAccessibilityPermission();
			if (!stillGranted) {
				console.warn('[Onboarding] ‚ö†Ô∏è Permission no longer granted after wait, aborting reinitialize');
				reinitializeInProgress = false;
				return;
			}

			console.log('[Onboarding] üîÑ Permission confirmed, calling reinitialize_fn_manager...');
			const { invoke } = await import('@tauri-apps/api/core');
			await invoke('reinitialize_fn_manager');
			console.log('[Onboarding] ‚úì Fn manager reinitialize command sent');

			console.log('[Onboarding] ‚è≥ Waiting 5s for event tap threads to initialize...');
			// Increased from 3s to 5s to give more time for event tap
			await new Promise((resolve) => setTimeout(resolve, 5000));

		// CRITICAL: Re-register all shortcuts with the newly initialized manager
		console.log('[Onboarding] üîÑ Re-registering shortcuts with new manager...');
		const { syncGlobalShortcutsWithSettings } = await import(
			'$lib/routes/+layout/register-commands'
		);
		await syncGlobalShortcutsWithSettings();
		console.log('[Onboarding] ‚úì Shortcuts re-registered');
			console.log('[Onboarding] ‚úÖ‚úÖ‚úÖ Fn keys should now be fully operational! ‚úÖ‚úÖ‚úÖ');
			console.log('[Onboarding] üí° TIP: Try using your Fn-based shortcut now!');
		} catch (error) {
			console.error('[Onboarding] ‚úó‚úó‚úó Failed to reinitialize Fn manager:', error);
		} finally {
			reinitializeInProgress = false;
		}
	}

	async function requestMicrophonePermission() {
		microphoneStatus = 'requesting';

		try {
			let tauriWindow = null;
			if (isDesktop) {
				try {
					const { getCurrentWindow } = await import('@tauri-apps/api/window');
					tauriWindow = getCurrentWindow();
					await tauriWindow.show();
					await tauriWindow.unminimize();
					await tauriWindow.setFocus();
					await tauriWindow.setAlwaysOnTop(true);
					await tauriWindow.setFocus();
					await new Promise((resolve) => setTimeout(resolve, 500));
					await tauriWindow.setFocus();
				} catch (e) {
					console.log('Could not set window state:', e);
				}
			}

			const stream = await navigator.mediaDevices.getUserMedia({
				audio: true,
				video: false,
			});

			if (stream) {
				stream.getTracks().forEach((track) => track.stop());
				microphoneStatus = 'granted';

				if (tauriWindow) {
					try {
						await tauriWindow.setAlwaysOnTop(false);
						await tauriWindow.setFocus();
					} catch (e) {
						console.log('Could not restore window:', e);
					}
				}

				rpc.notify.success.execute({
					title: 'Microphone access granted',
					description: 'You can now record audio',
				});
			}
		} catch {
			microphoneStatus = 'denied';
			rpc.notify.error.execute({
				title: 'Microphone access denied',
				description: 'Please allow microphone access in your system settings',
			});
		}

		setTimeout(checkPermissions, 500);
	}

	async function requestAccessibilityPermission() {
		if (!isDesktop) return;

		accessibilityStatus = 'requesting';

		try {
			console.log('[Onboarding] === Starting accessibility permission request ===');
			// Disable always-on-top so user can see System Settings dialog
			let tauriWindow = null;
			try {
				const { getCurrentWindow } = await import('@tauri-apps/api/window');
				tauriWindow = getCurrentWindow();
				await tauriWindow.setAlwaysOnTop(false);
				console.log('[Onboarding] Window setAlwaysOnTop(false) completed');
			} catch (e) {
				console.log('[Onboarding] Could not disable always on top:', e);
			}

			const { invoke } = await import('@tauri-apps/api/core');
			console.log('[Onboarding] About to call is_macos_accessibility_enabled with askIfNotAllowed=true');
			await invoke<boolean>('is_macos_accessibility_enabled', {
				askIfNotAllowed: true,
			});
			console.log('[Onboarding] First accessibility check completed, waiting 1s...');

			await new Promise((resolve) => setTimeout(resolve, 1000));

			console.log('[Onboarding] Checking final accessibility status...');
			const finalResult = await invoke<boolean>('is_macos_accessibility_enabled', {
				askIfNotAllowed: false,
			});
			console.log('[Onboarding] Final accessibility result:', finalResult);

			if (finalResult) {
				console.log('[Onboarding] ‚úì Accessibility granted, setting status...');
				accessibilityStatus = 'granted';

				console.log('[Onboarding] Showing success notification...');
				rpc.notify.success.execute({
					title: 'Accessibility access granted',
					description: 'You can now use direct paste',
				});
			} else {
				console.log('[Onboarding] ‚úó Accessibility denied, setting status...');
				accessibilityStatus = 'denied';
				rpc.notify.warning.execute({
					title: 'Accessibility permission needed',
					description: 'Enable in System Settings > Privacy > Accessibility',
				});
			}
		} catch (error) {
			console.error('[Onboarding] ‚úó‚úó‚úó Exception in requestAccessibilityPermission:', error);
			accessibilityStatus = 'denied';
		}

		setTimeout(checkPermissions, 1500);
	}

	onMount(() => {
		checkPermissions();

		const interval = setInterval(() => {
			if (!isCheckingPermissions) {
				checkPermissions();
			}
		}, 2000);

		return () => clearInterval(interval);
	});
</script>

<div class="flex flex-col p-8 space-y-6">
	<!-- Header with Progress -->
	<div class="text-center space-y-3">
		<p class="text-xs text-white/40 uppercase tracking-wider font-medium">
			Step {completedSteps + 1 > totalSteps ? totalSteps : completedSteps + 1} of {totalSteps}
		</p>
		<h2 class="text-xl font-semibold text-white/95">Grant Permissions</h2>
	</div>

	<!-- Permissions List -->
	<div class="space-y-4">
		<!-- Microphone Permission -->
		<div
			class="p-4 rounded-xl border transition-all duration-300 {microphoneStatus === 'granted'
				? 'border-green-500/30 bg-green-500/5'
				: 'border-white/10 bg-white/[0.02]'}"
		>
			<div class="flex items-start gap-3">
				<!-- Step indicator -->
				<div
					class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 transition-colors duration-300 {microphoneStatus === 'granted'
						? 'bg-green-500 text-white'
						: 'bg-white/10 text-white/60'}"
				>
					{#if microphoneStatus === 'granted'}
						<CheckIcon class="w-4 h-4" />
					{:else}
						<MicIcon class="w-4 h-4" />
					{/if}
				</div>

				<div class="flex-1 min-w-0">
					<div class="flex items-center justify-between gap-2">
						<h3 class="font-medium text-sm text-white/90">Microphone Access</h3>
						{#if microphoneStatus === 'granted'}
							<span class="text-xs font-medium text-green-400">Done</span>
						{/if}
					</div>
					<p class="text-xs text-white/50 mt-1">
						So you can speak instead of typing.
					</p>

					{#if microphoneStatus !== 'granted'}
						<div class="mt-3">
							{#if microphoneStatus === 'requesting'}
								<div class="flex items-center gap-2 text-xs text-white/50">
									<LoaderIcon class="w-3 h-3 animate-spin" />
									<span>Waiting for permission...</span>
								</div>
							{:else}
								<Button size="sm" onclick={requestMicrophonePermission} class="cursor-pointer">
									Allow Microphone
								</Button>
							{/if}
						</div>
					{/if}
				</div>
			</div>
		</div>

		<!-- Accessibility Permission (Desktop only) -->
		{#if isDesktop}
			<div
				class="p-4 rounded-xl border transition-all duration-300 {accessibilityStatus === 'granted'
					? 'border-green-500/30 bg-green-500/5'
					: 'border-white/10 bg-white/[0.02]'}"
			>
				<div class="flex items-start gap-3">
					<!-- Step indicator -->
					<div
						class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 transition-colors duration-300 {accessibilityStatus === 'granted'
							? 'bg-green-500 text-white'
							: 'bg-white/10 text-white/60'}"
					>
						{#if accessibilityStatus === 'granted'}
							<CheckIcon class="w-4 h-4" />
						{:else}
							<ShieldIcon class="w-4 h-4" />
						{/if}
					</div>

					<div class="flex-1 min-w-0">
						<div class="flex items-center justify-between gap-2">
							<h3 class="font-medium text-sm text-white/90">Accessibility Access</h3>
							{#if accessibilityStatus === 'granted'}
								<span class="text-xs font-medium text-green-400">Done</span>
							{/if}
						</div>
						<p class="text-xs text-white/50 mt-1">
							So NoteFlux can paste your text anywhere instantly.
						</p>

						{#if accessibilityStatus !== 'granted'}
							<div class="mt-3">
								{#if accessibilityStatus === 'requesting'}
									<div class="flex items-center gap-2 text-xs text-white/50">
										<LoaderIcon class="w-3 h-3 animate-spin" />
										<span>Opening System Settings...</span>
									</div>
								{:else}
									<Button size="sm" variant="outline" onclick={requestAccessibilityPermission} class="cursor-pointer">
										Open Settings
									</Button>
								{/if}
							</div>
						{/if}
					</div>
				</div>
			</div>
		{/if}
	</div>

	<!-- Status Message -->
	{#if allRequiredGranted}
		<div class="text-center py-2">
			<p class="text-sm text-green-400 font-medium">
				All set! Continuing...
			</p>
		</div>
	{/if}
</div>
